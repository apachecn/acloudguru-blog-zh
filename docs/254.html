<html>
<head>
<title>Build your own multi-user photo album app with React, GraphQL, and AWS Amplifyâ€Šâ€”â€ŠPart 2 of 3 | A Cloud Guru</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>ä½¿ç”¨Reactã€GraphQLå’ŒAWS Amplifyæ„å»ºæ‚¨è‡ªå·±çš„å¤šç”¨æˆ·ç›¸å†Œåº”ç”¨ç¨‹åºâ€”ç¬¬2éƒ¨åˆ†ï¼Œå…±3éƒ¨åˆ†|äº‘ä¸“å®¶</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://acloudguru.com/blog/engineering/build-your-own-multi-user-photo-album-app-with-react-graphql-and-aws-amplify-part2#0001-01-01">https://acloudguru.com/blog/engineering/build-your-own-multi-user-photo-album-app-with-react-graphql-and-aws-amplify-part2#0001-01-01</a></blockquote><div><div class="elementor-widget-container"><p class="has-text-align-center" id="h-add-url-routing-photo-uploads-and-an-album-details-view">æ·»åŠ URLè·¯ç”±ã€ç…§ç‰‡ä¸Šä¼ å’Œç›¸å†Œè¯¦ç»†ä¿¡æ¯è§†å›¾</p><p><a href="https://acloudguru.com/blog/engineering/build-your-own-multi-user-photo-album-app-with-react-graphql-and-aws-amplify-part1" target="_blank" rel="noreferrer noopener"> <strong> <em>ç¬¬ä¸€éƒ¨åˆ†</em> </strong> </a> <strong> <em> |ç¬¬äºŒéƒ¨åˆ†| </em> </strong> <a href="https://acloudguru.com/blog/engineering/build-your-own-multi-user-photo-album-app-with-react-graphql-and-aws-amplify-part3" target="_blank" rel="noreferrer noopener"> <strong> <em>ç¬¬ä¸‰éƒ¨åˆ†</em> </strong> </a> <em> <br/>è¿™æ˜¯ä¸€ä¸ªç”±ä¸‰éƒ¨åˆ†ç»„æˆçš„ç³»åˆ—æ–‡ç« çš„ç¬¬äºŒç¯‡ï¼Œå‘æ‚¨å±•ç¤ºå¦‚ä½•åœ¨AWSä¸Šæ„å»ºä¸€ä¸ªå¯æ‰©å±•çš„ã€é«˜åº¦å¯ç”¨çš„æ— æœåŠ¡å™¨webåº”ç”¨ç¨‹åºï¼Œå…è®¸ç”¨æˆ·å°†ç…§ç‰‡ä¸Šä¼ åˆ°ç›¸å†Œå¹¶ä¸ä»–äººç§ä¸‹å…±äº«è¿™äº›ç›¸å†Œã€‚</em></p><hr class="wp-block-separator is-style-dots"/><p><strong>æ³¨æ„:</strong>è‡ªä»è¿™ä¸ªç³»åˆ—çš„æœ€åˆå‡ºç‰ˆä»¥æ¥ï¼Œæˆ‘å·²ç»å°†è¿™äº›å†…å®¹æ”¹ç¼–æˆäº†ä¸€ä¸ªå¯åœ¨çº¿è®¿é—®çš„è‡ªå®šè¿›åº¦çš„ç ”è®¨ä¼šï¼Œç½‘å€:ã€https://amplify-workshop.go-aws.com/ã€‘<br/><a href="https://amplify-workshop.go-aws.com/" target="_blank" rel="noreferrer noopener"/></p><hr class="wp-block-separator is-style-dots"/><p id="4c18">åœ¨<a href="https://acloudguru.com/blog/engineering/build-your-own-multi-user-photo-album-app-with-react-graphql-and-aws-amplify-part1" target="_blank" rel="noreferrer noopener">ç¬¬ä¸€éƒ¨åˆ†</a>ä¸­ï¼Œæˆ‘ä»¬å¯åŠ¨äº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œæ·»åŠ äº†èº«ä»½éªŒè¯ï¼Œå¹¶é›†æˆäº†ä¸€ä¸ªGraphQL APIï¼Œç”¨äºé€šè¿‡webå‰ç«¯åˆ›å»ºç›¸å†Œè®°å½•ï¼Œè®©æˆ‘ä»¬åˆ—å‡ºç›¸å†Œåç§°å¹¶åˆ›å»ºæ–°çš„ç›¸å†Œåç§°ã€‚</p><p id="8a79">åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è¿›è¡Œä»¥ä¸‹æ”¹è¿›:</p><ul><li>æ·»åŠ URLè·¯ç”±å’Œè§†å›¾ï¼Œä»¥ä¾¿åœ¨ç›¸å†Œåˆ—è¡¨å’ŒæŸ¥çœ‹ç›¸å†Œè¯¦ç»†ä¿¡æ¯ä¹‹é—´åˆ‡æ¢</li><li>ä½¿ç”¨S3å°†ç…§ç‰‡ä¸Šä¼ åˆ°ç›¸å†Œï¼Œåœ¨äº‘ä¸­è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾ï¼Œå¹¶å°†ç…§ç‰‡å…ƒæ•°æ®å­˜å‚¨åœ¨å¦ä¸€ä¸ªDynamoDBè¡¨ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†ç…§ç‰‡é“¾æ¥åˆ°ç›¸å†Œ</li><li>ä½¿ç”¨GraphQLæ¨¡å¼ä¸­ç›¸å†Œç±»å‹å†…çš„åµŒå¥—ç…§ç‰‡å­—æ®µè·å–æ‰€é€‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡</li></ul><h3 id="0f09">å…ˆå†³æ¡ä»¶</h3><p id="d33a">åœ¨æˆ‘ä»¬ç»§ç»­ä¸‹é¢çš„æ­¥éª¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªè¦æ±‚ã€‚</p><p id="d33a"><strong>å®‰è£…SAM CLI </strong> â€”åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨AWSçš„ä¸€ä¸ªå·¥å…·æ¥å¸®åŠ©æ‰“åŒ…å’Œéƒ¨ç½²AWS Lambdaå‡½æ•°ï¼Œè¯¥å·¥å…·åä¸º<a href="https://github.com/awslabs/serverless-application-model" target="_blank" rel="noreferrer noopener"> AWSæ— æœåŠ¡å™¨åº”ç”¨ç¨‹åºæ¨¡å‹(SAM) </a>å’Œ<a href="https://github.com/awslabs/aws-sam-cli" target="_blank" rel="noreferrer noopener"> SAM CLI </a>ã€‚è¯·éµå¾ªSAM CLI çš„<a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html" target="_blank" rel="noreferrer noopener">å®‰è£…è¯´æ˜ï¼Œè¿™ä¹Ÿéœ€è¦æ‚¨å®‰è£…Docker(SAMå®‰è£…è¯´æ˜ä¸­æä¾›äº†ç›¸å…³é“¾æ¥)ã€‚</a></p><h3 id="205e">æ·»åŠ è·¯ç”±å’Œç›¸å†Œè¯¦ç»†ä¿¡æ¯è§†å›¾</h3><p id="289b">é¦–å…ˆï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›æœ‰ä¸¤ç§æ¨¡å¼â€”â€”ä¸€ä¸ªç›¸å†Œåˆ—è¡¨è§†å›¾å’Œä¸€ä¸ªç›¸å†Œç»†èŠ‚è§†å›¾â€”â€”è®©æˆ‘ä»¬ä½¿ç”¨<a href="https://reacttraining.com/react-router/web/guides/quick-start" target="_blank" rel="noreferrer noopener"> react-router-dom </a>å’Œä¸€äº›æ–°ç»„ä»¶ä¸ºReactåº”ç”¨ç¨‹åºæ·»åŠ ä¸€äº›ç®€å•çš„è·¯ç”±ï¼Œä»¥å¸®åŠ©åŠ è½½ç›¸å†Œçš„ç»†èŠ‚å’Œå‘ˆç°ç›¸å†Œã€‚<br/> <br/>è·‘<code>npm install --save react-router-dom</code></p><p id="63a4">ç„¶åï¼Œåœ¨<code>App.js</code>çš„é¡¶éƒ¨æ·»åŠ ä¸€äº›å¯¼å…¥ï¼Œåˆ›å»ºä¸€äº›æ–°çš„ç»„ä»¶æ¥åŠ è½½å’Œå‘ˆç°ä¸€ä¸ªç›¸å†Œï¼Œå¹¶ä¿®æ”¹æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç»„ä»¶æ¥æ ¹æ®æˆ‘ä»¬æ‰€å¤„çš„è·¯çº¿å‘ˆç°ä¸åŒçš„ç»„ä»¶ã€‚å¯¹<code>src/App.js</code>è¿›è¡Œä»¥ä¸‹æ›´æ”¹ã€‚</p><pre class="wp-block-code"><code>// src/App.js
// 1. NEW: Import the routing components
import {BrowserRouter as Router, Route, NavLink} from 'react-router-dom';

// 2. NEW: Add a new query we can use to render an album's details
const GetAlbum = `query GetAlbum($id: ID!) {
  getAlbum(id: $id) {
    id
    name
  }
}
`;

// 3. NEW: Create an AlbumDetailsLoader component
//    to load the details for an album
class AlbumDetailsLoader extends React.Component {
  render() {
    return (
      &lt;Connect query={graphqlOperation(GetAlbum, { id: this.props.id })}&gt;
        {({ data, loading, errors }) =&gt; {
          if (loading) { return &lt;div&gt;Loading...&lt;/div&gt;; }
          if (errors.length &gt; 0) { return &lt;div&gt;{JSON.stringify(errors)}&lt;/div&gt;; }
          if (!data.getAlbum) return;
          return &lt;AlbumDetails album={data.getAlbum} /&gt;;
        }}
      &lt;/Connect&gt;
    );
  }
}

// 4. NEW: Create an AlbumDetails component
class AlbumDetails extends Component {
  render() {
    return (
      &lt;Segment&gt;
        &lt;Header as='h3'&gt;{this.props.album.name}&lt;/Header&gt;
        &lt;p&gt;TODO: Allow photo uploads&lt;/p&gt;
        &lt;p&gt;TODO: Show photos for this album&lt;/p&gt;
      &lt;/Segment&gt;
    )
  }
}
// 5. EDIT: Replace the App component's render() method 
//    with updated code to control which components 
//    render depending on what route we're on
class App extends Component {
  // ...
  // Leave other parts of the App component alone
  // ...

  // Replace the render() method with this version: 
  render() {
    return (
      &lt;Router&gt;
        &lt;Grid padded&gt;
          &lt;Grid.Column&gt;
            &lt;Route path="/" exact component={NewAlbum}/&gt;
            &lt;Route path="/" exact component={AlbumsListLoader}/&gt;
            &lt;Route
              path="/albums/:albumId"
              render={ () =&gt; &lt;div&gt;&lt;NavLink to='/'&gt;Back to Albums list&lt;/NavLink&gt;&lt;/div&gt; }
            /&gt;
            &lt;Route
              path="/albums/:albumId"
              render={ props =&gt; &lt;AlbumDetailsLoader id={props.match.params.albumId}/&gt; }
            /&gt;
          &lt;/Grid.Column&gt;
        &lt;/Grid&gt;
      &lt;/Router&gt;
    );
  }
}</code></pre><p>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåœ¨è¿™ä¸€ç‚¹ä¸Šçœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•ä¸åŒï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¿®æ”¹AlbumsListç»„ä»¶ï¼Œå°†ç›¸å†Œåç§°å‘ˆç°ä¸ºéµå¾ªä¸Šé¢è®¾ç½®çš„è·¯ç”±è·¯å¾„çš„é“¾æ¥ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿç‚¹å‡»å¹¶æŸ¥çœ‹ç›¸å†Œã€‚å½“ç„¶ï¼Œå½“æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸ªç›¸å†Œçš„è¯¦ç»†ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªé“¾æ¥æ¥è¿”å›ç›¸å†Œåˆ—è¡¨ã€‚è®©æˆ‘ä»¬æŠŠè¿™äº›éƒ½åŠ è¿›å»ã€‚å¯¹<code>src/App.js</code>è¿›è¡Œä»¥ä¸‹æ›´æ”¹:</p><pre class="wp-block-code"><code>// src/App.js
// 1. EDIT: Replace the AlbumsList component's albumItems()
//    with updated code to output the names as nav links
class AlbumsList extends React.Component {
  // Replace the existing albumItems() with this new one:
  albumItems() {
    return this.props.albums.sort(makeComparator('name')).map(album =&gt;
      &lt;List.Item key={album.id}&gt;
        &lt;NavLink to={`/albums/${album.id}`}&gt;{album.name}&lt;/NavLink&gt;
      &lt;/List.Item&gt;
    );
  }
  
  // ... the rest of the AlbumsList component remains unchanged
}</code></pre><p id="7b52">æ­¤æ—¶ï¼Œå¦‚æœæ‚¨æŸ¥çœ‹è¯¥åº”ç”¨ç¨‹åºï¼Œæ‚¨ä¼šçœ‹åˆ°æˆ‘ä»¬å¯ä»¥å•å‡»æŸä¸ªä¸“è¾‘çš„åç§°ï¼Œç„¶åæˆ‘ä»¬å°†æ›´æ”¹è§†å›¾å¹¶æŸ¥çœ‹è¯¥ä¸“è¾‘çš„è¯¦ç»†ä¿¡æ¯(æ­¤å¤–ï¼Œæˆ‘ä»¬åœ¨é¡¶éƒ¨æœ‰ä¸€ä¸ªé“¾æ¥ï¼Œå¯ä»¥è¿”å›åˆ°æˆ‘ä»¬çš„ä¸“è¾‘åˆ—è¡¨)ã€‚å½“ç„¶ï¼Œç°åœ¨æˆ‘ä»¬æ‰€æœ‰çš„AlbumDetailsç»„ä»¶æ‰€åšçš„æ˜¯å‘ˆç°ä¸“è¾‘çš„åç§°ï¼ŒåŠ ä¸Šä¸€äº›æˆ‘ä»¬ç¨åä¼šç”¨åˆ°çš„å¾…åŠäº‹é¡¹ã€‚åœ¨æˆ‘ä»¬æ·»åŠ ä¸Šä¼ ç…§ç‰‡åˆ°ç›¸å†Œçš„åŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸ä¼šè·å–ä»»ä½•å…¶ä»–ç›¸å†Œä¿¡æ¯ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚</p><h3 id="0a07">å°†ç…§ç‰‡ä¸Šä¼ æ·»åŠ åˆ°ç›¸å†Œ</h3><p id="99d7">æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ°æ–¹æ¥å­˜å‚¨ä¸Šä¼ åˆ°æˆ‘ä»¬ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡ï¼Œäºšé©¬é€Šç®€å•å­˜å‚¨æœåŠ¡(S3)æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Amplify CLIä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¯ç”¨å­˜å‚¨ï¼Œè¿™å°†åœ¨äºšé©¬é€ŠS3ä¸Šåˆ›å»ºä¸€ä¸ªå­˜å‚¨æ¡¶ï¼Œå¹¶ä¸ºå…¶è®¾ç½®é€‚å½“çš„æƒé™ï¼Œä»¥ä¾¿ç™»å½•åˆ°æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„ç”¨æˆ·å¯ä»¥åœ¨ä¸åŒçš„ä½ç½®å’Œæƒé™å¯¹å…¶è¿›è¡Œè¯»å†™ã€‚æ‚¨å¯ä»¥ç‚¹å‡»äº†è§£æ›´å¤šå…³äºå­˜å‚¨æ¨¡å—<a href="https://aws-amplify.github.io/amplify-js/media/storage_guide" target="_blank" rel="noreferrer noopener">çš„ä¿¡æ¯ã€‚</a></p><p id="c5b2">è¿è¡Œ<code>amplify add storage</code>ï¼Œåœ¨æç¤ºç¬¦ä¸‹é€‰æ‹©â€œ<strong>å†…å®¹</strong>ï¼Œå¯ä»¥é€‰æ‹©ä¸ºèµ„æºç±»åˆ«å’Œæ¡¶åè¾“å…¥æ‚¨è‡ªå·±çš„åç§°ï¼Œå¹¶å¯¹å…¶è¿›è¡Œé…ç½®ï¼Œä»¥ä¾¿åªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æ‰èƒ½è®¿é—®ï¼Œå¹¶å…·æœ‰å®Œå…¨çš„è¯»/å†™æƒé™ã€‚ç„¶åè¿è¡Œ<code>amplify push</code>ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¦æœ‰å“åº”çš„ç¤ºä¾‹è¾“å‡º:</p><pre class="wp-block-code"><code>$ amplify add storage
? Please select from one of the below mentioned services: Content (Images, audio, video, etc.)
? Please provide a friendly name for your resource that will be used to label this category in the project: photoalbumsstorage
? Please provide bucket name: &lt;accept the default value&gt;
? Who should have access: Auth users only
? What kind of access do you want for Authenticated users: read/write
$ amplify push</code></pre><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå¯ä»¥å­˜å‚¨ç…§ç‰‡çš„S3å­˜å‚¨æ¡¶ï¼Œæˆ‘ä»¬æƒ³åˆ›å»ºä¸€ä¸ªUIï¼Œè®©æˆ‘ä»¬å¯ä»¥å°†ç…§ç‰‡ä¸Šä¼ åˆ°è¿™ä¸ªå­˜å‚¨æ¡¶ä¸­è¿›è¡Œå­˜å‚¨ã€‚ç„¶åï¼Œæˆ‘ä»¬éœ€è¦è·Ÿè¸ªè¯¥ç…§ç‰‡è¢«ä¸Šä¼ åˆ°ç›¸å†Œçš„æ„å›¾ï¼Œä»¥ä¾¿æˆ‘ä»¬æœ€ç»ˆå¯ä»¥åŠ è½½å±äºç‰¹å®šç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡ã€‚<br/> <br/>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„<code>S3ImageUpload</code>ç»„ä»¶ï¼Œå®ƒå°†åŒ…å«ä¸€ä¸ªHTMLæ–‡ä»¶è¾“å…¥å…ƒç´ ï¼Œå½“ç”¨æˆ·é€‰æ‹©ä¸€å¼ ç…§ç‰‡æ—¶ï¼Œå®ƒå°†è§¦å‘ä¸€ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºã€‚æˆ‘ä»¬çš„ä¸Šä¼ äº‹ä»¶å¤„ç†ç¨‹åºå°†éœ€è¦ä¸Šä¼ æ–‡ä»¶åˆ°S3ä¸ä¸€äº›å…ƒæ•°æ®æ³¨é‡Šå®ƒçš„ç›®çš„åœ°ä¸“è¾‘ã€‚å¹¸è¿çš„æ˜¯ï¼Œ<a href="https://aws-amplify.github.io/amplify-js/media/storage_guide" target="_blank" rel="noreferrer noopener"> Amplify JSå­˜å‚¨æ¨¡å—</a>è®©ä¸Šä¼ æ–‡ä»¶åˆ°S3å˜å¾—éå¸¸å®¹æ˜“ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¼•å…¥ä¸€ä¸ªæ–°çš„ä¾èµ–é¡¹â€”â€”ä¸€ç§ç”ŸæˆUUIDsçš„æ–¹æ³•â€”â€”å› ä¸ºæˆ‘ä»¬éœ€è¦ç¡®ä¿ä¸Šä¼ åˆ°S3çš„æ–‡ä»¶å…·æœ‰å”¯ä¸€çš„åç§°(å¦‚æœæˆ‘ä»¬ä½¿ç”¨ç”¨æˆ·è®¾å¤‡ä¸Šçš„æ–‡ä»¶åï¼Œå®ƒä»¬å¯èƒ½ä¼šå†²çª)ã€‚<br/> <br/>è¿è¡Œ<code>npm install --save uuid</code>ç„¶åæ›´æ–°æˆ‘ä»¬çš„<code>src/App.js</code>æ–‡ä»¶ï¼Œæ·»åŠ ä¸€äº›å¯¼å…¥ï¼Œåˆ›å»ºä¸€ä¸ª<code>S3ImageUpload</code>ç»„ä»¶ï¼Œå¹¶å°†<code>S3ImageUpload</code>ç»„ä»¶åŒ…å«åœ¨<code>AlbumDetails</code>ç»„ä»¶ä¸­ã€‚å¯¹<code>src/App.js</code>è¿›è¡Œä»¥ä¸‹æ›´æ”¹:</p><pre class="wp-block-code"><code>// src/App.js
// 1. NEW: Add imports from uuid and semantic-ui-react
import {v4 as uuid} from 'uuid';
import { Form, Grid, Header, Input, List, Segment } from 'semantic-ui-react';

// 2. EDIT: add an import of Storage from Amplify
import Amplify, { API, graphqlOperation, Storage } from 'aws-amplify';

// 3. NEW: Create an S3ImageUpload component
class S3ImageUpload extends React.Component {
  constructor(props) {
    super(props);
    this.state = { uploading: false }
  }
  onChange = async (e) =&gt; {
    const file = e.target.files[0];
    const fileName = uuid();
    this.setState({uploading: true});
    const result = await Storage.put(
      fileName, 
      file, 
      {
        customPrefix: { public: 'uploads/' },
        metadata: { albumid: this.props.albumId }
      }
    );
    console.log('Uploaded file: ', result);
    this.setState({uploading: false});
  }
  render() {
    return (
      &lt;div&gt;
        &lt;Form.Button
          onClick={() =&gt; document.getElementById('add-image-file-input').click()}
          disabled={this.state.uploading}
          icon='file image outline'
          content={ this.state.uploading ? 'Uploading...' : 'Add Image' }
        /&gt;
        &lt;input
          id='add-image-file-input'
          type="file"
          accept='image/*'
          onChange={this.onChange}
          style={{ display: 'none' }}
        /&gt;
      &lt;/div&gt;
    );
  }
}

// 4. EDIT: Add the S3ImageUpload component 
//    to the AlbumDetails component
class AlbumDetails extends Component {
  render() {
    return (
      &lt;Segment&gt;
        &lt;Header as='h3'&gt;{this.props.album.name}&lt;/Header&gt;
        &lt;S3ImageUpload albumId={this.props.album.id}/&gt;        
        &lt;p&gt;TODO: Show photos for this album&lt;/p&gt;
      &lt;/Segment&gt;
    )
  }
}</code></pre><p>åœ¨è¿™ä¸€ç‚¹ä¸Šæ²¡æœ‰å¤ªå¤šè¦çœ‹çš„ï¼Œä½†æ˜¯ä½ åº”è¯¥èƒ½å¤Ÿç‚¹å‡»æŒ‰é’®ï¼Œé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶çœ‹åˆ°å®ƒæ”¹å˜ä¸º<em>â€˜Uploadingâ€¦â€™</em>ï¼Œç„¶åå†æ¬¡åˆ‡æ¢å›ä¸Šä¼ æŒ‰é’®ã€‚æ‚¨è¿˜å¯ä»¥åœ¨AWS webæ§åˆ¶å°ä¸­æ‰‹åŠ¨æµè§ˆS3æ¡¶ï¼ŒæŸ¥çœ‹æ–‡ä»¶æ˜¯å¦æ­£åœ¨ä¸Šä¼ ã€‚æ‰¾åˆ°bucketåç§°æœ€ç®€å•çš„æ–¹æ³•æ˜¯æŸ¥çœ‹<code>src/aws-exports.js</code>å¹¶æ‰¾åˆ°ä¸º<code>aws_user_files_s3_bucket</code>é…ç½®çš„å€¼ã€‚åœ¨S3ç½‘ç»œæ§åˆ¶å°ä¸­æ‰¾åˆ°ä½ çš„æ¡¶ï¼Œç„¶ååœ¨<code>public/uploads</code>ä¸‹çš„æ¡¶ä¸­æŸ¥æ‰¾ã€‚<br/> <br/>åœ¨æˆ‘ä»¬çš„æ–°<code>S3ImageUpload</code>ç»„ä»¶ä¸­ï¼Œæœ‰ä¸€äº›ä¸œè¥¿å€¼å¾—ä¸€æã€‚å®ƒä½¿ç”¨AWS Amplifyçš„<code>Storage.put</code>æ–¹æ³•å°†æ–‡ä»¶ä¸Šä¼ åˆ°æˆ‘ä»¬ä¸ºåº”ç”¨ç¨‹åºé…ç½®çš„S3æ¡¶ä¸­ã€‚åœ¨è¿™ä¸ªAPIè°ƒç”¨ä¸­ï¼Œæˆ‘ä»¬ä¼ é€’äº†ä¸€äº›é¢å¤–çš„é€‰é¡¹ã€‚<br/> <br/>æˆ‘ä»¬ä¼ å…¥<code>customPrefix: { public: 'uploads/' }</code>æ˜¯å› ä¸ºæˆ‘ä»¬æƒ³è‡ªåŠ¨ä¸ºæ¯å¼ å›¾ç‰‡åˆ¶ä½œç¼©ç•¥å›¾ã€‚æˆ‘ä»¬å°†é€šè¿‡åœ¨S3å­˜å‚¨æ¡¶ä¸Šæ·»åŠ ä¸€ä¸ªè§¦å‘å™¨æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œæ¯å½“ä»»ä½•æ–‡ä»¶è¢«æ·»åŠ åˆ°å­˜å‚¨æ¡¶çš„<code>uploads/</code>è·¯å¾„æ—¶ï¼Œè¿™ä¸ªè§¦å‘å™¨å°†ä¸ºæˆ‘ä»¬è§¦å‘ä¸€ä¸ªç¼©ç•¥å›¾åˆ›å»ºåŠŸèƒ½ã€‚æ–°çš„ç¼©ç•¥å›¾ä¹Ÿå°†è¢«æ·»åŠ åˆ°æ¡¶ä¸­ï¼Œä¸ºäº†é¿å…é€’å½’è§¦å‘å™¨å¾ªç¯ï¼Œå…¶ä¸­æ¯ä¸ªç¼©ç•¥å›¾çš„åˆ›å»ºéƒ½ä¼šå¯¼è‡´å‡½æ•°å†æ¬¡è§¦å‘ï¼Œæˆ‘ä»¬å°†æˆ‘ä»¬çš„è§¦å‘å™¨é™å®šä¸ºåªå¯¹æ·»åŠ äº†å…³é”®å­—å‰ç¼€<code>uploads/</code>çš„æ–‡ä»¶æ‰§è¡Œã€‚AmplifyçŸ¥é“ä½¿ç”¨æˆ‘ä»¬çš„å‰ç¼€ï¼Œå› ä¸ºæˆ‘ä»¬æŒ‡å®šå®ƒç”¨äºåº”è¯¥å…¬å¼€è®¿é—®çš„æ–‡ä»¶ï¼Œè¿™æ˜¯<code>Storage.put</code>çš„é»˜è®¤æƒé™çº§åˆ«ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®(åœ¨APIçº§åˆ«)æ‰€æœ‰æ–‡ä»¶ï¼Œè¿™æœ‰é—®é¢˜å—ï¼Ÿä¸ã€‚è¿™æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯¹ç…§ç‰‡é”®ä½¿ç”¨äº†ä¸å¯è®¿é—®çš„UUIDï¼Œå¦‚æœç”¨æˆ·çŸ¥é“æŸä¸ªç›¸å†Œçš„UUIDï¼Œä»–ä»¬å°†åªèƒ½æ£€ç´¢è¯¥ç›¸å†Œçš„ç…§ç‰‡åˆ—è¡¨ã€‚å¦‚æœä½ å»é˜…è¯»æ‰€æœ‰çš„Amplifyå­˜å‚¨æ¨¡å—çš„API(æˆ–è€…å¦‚æœä½ ç†Ÿæ‚‰åº•å±‚çš„S3 API)ï¼Œä½ å¯èƒ½ä¼šé—®â€œä½†æ˜¯ç­‰ç­‰ï¼Œç”¨æˆ·å¯ä»¥åªåˆ—å‡ºå…¬å…±è·¯å¾„ä¸­çš„æ‰€æœ‰å¯¹è±¡å¹¶çœ‹åˆ°æ‰€æœ‰çš„ç…§ç‰‡ï¼â€ç›®å‰ï¼Œä½ æ˜¯å¯¹çš„ï¼Œä½†æˆ‘ä»¬ç¨åä¼šå¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå·¥ä½œå¹¶é‡‡å–é¢å¤–çš„é¢„é˜²æªæ–½æ¥è¿›ä¸€æ­¥é”å®šå®ƒ(é€šè¿‡å°†ç›¸å†Œåˆ—è¡¨é™åˆ¶åˆ°æŸäº›ç”¨æˆ·åï¼Œå¹¶é˜²æ­¢ç”¨æˆ·åœ¨æ¡¶ä¸­åˆ—å‡ºé¡¹ç›®)ã€‚<br/> <br/>æˆ‘ä»¬ä¼ å…¥<code>metadata: { albumid: this.props.albumId }</code>ï¼Œå› ä¸ºæˆ‘ä»¬è¦è®©æˆ‘ä»¬çš„ç¼©ç•¥å›¾<a href="https://acloudguru.com/hands-on-labs/setting-up-lambda-functions-with-s3-event-triggers">S3Î»è§¦å‘å™¨</a>å‡½æ•°åœ¨å®Œæˆç¼©ç•¥å›¾åˆ¶ä½œåï¼Œè´Ÿè´£å°†å…³äºè¿™å¼ ç…§ç‰‡çš„ä¿¡æ¯æ·»åŠ åˆ°æˆ‘ä»¬çš„æ•°æ®å­˜å‚¨ä¸­ï¼Œå¹¶ä¸”è¯¥å‡½æ•°éœ€è¦çŸ¥é“ç…§ç‰‡ä¸Šä¼ åˆ°äº†å“ªä¸ªç›¸å†Œã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç›¸å†ŒIDä½œä¸ºå‰ç¼€æˆ–åç¼€æ”¾åœ¨photo keyä¸­ï¼Œä½†æˆ‘è®¤ä¸ºå…ƒæ•°æ®æ–¹æ³•æ›´å¥½ã€‚æ¯•ç«Ÿè¿™ä¸ª<em>æ˜¯å…³äºç…§ç‰‡çš„</em>å…ƒæ•°æ®å§ï¼Ÿ</p><h3 id="ba31">ç”Ÿæˆç¼©ç•¥å›¾</h3><p id="c660">åŸºäºAWSæ„å»ºçš„ä¸€ä¸ªå¥½å¤„æ˜¯æœåŠ¡ä¹‹é—´çš„é›†æˆã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸€äº›æœåŠ¡å™¨ç«¯ä»£ç ä¸ºæˆ‘ä»¬ä¸Šä¼ çš„æ¯å¼ å›¾ç‰‡ç”Ÿæˆç¼©ç•¥å›¾ã€‚åœ¨AWSä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªAWS Lambdaå‡½æ•°å¹¶è®¾ç½®æˆ‘ä»¬çš„S3æ¡¶æ¥åœ¨æ–°å¯¹è±¡è¿›å…¥æ¡¶æ—¶è§¦å‘è¯¥å‡½æ•°ï¼Œä»¥æ— æœåŠ¡å™¨çš„æ–¹å¼å®ç°è¿™ä¸€ç‚¹ã€‚AWS Lambdaå…è®¸ä½ ç”¨å¤šç§ç¼–ç¨‹è¯­è¨€åˆ›ä½œå‡½æ•°ï¼Œä½†ç”±äºæˆ‘ä»¬ç›®å‰ä¸ºæ­¢åœ¨è¿™ä¸ªåº”ç”¨ç¨‹åºä¸­åªä½¿ç”¨JavaScriptï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç•™åœ¨JSé¢†åŸŸï¼Œåˆ›å»ºä¸€ä¸ªå°†åœ¨Node.js 8.10ä¸Šè¿è¡Œçš„Lambdaå‡½æ•°ã€‚æœ‰å¾ˆå¤šé€‰é¡¹å¯ä»¥å¸®åŠ©æ‚¨åœ¨AWS Lambdaä¸Šåˆ›ä½œå’Œéƒ¨ç½²å‡½æ•°ã€‚å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a href="https://github.com/awslabs/serverless-application-model" target="_blank" rel="noreferrer noopener"> AWSæ— æœåŠ¡å™¨åº”ç”¨ç¨‹åºæ¨¡å‹(SAM) </a>å’Œ<a href="https://github.com/awslabs/aws-sam-cli" target="_blank" rel="noreferrer noopener"> SAM CLI </a>ã€‚</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/09a41e134ecaec3c0ba74a3ab62067a0.png" alt="" class="wp-image-42763" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_4trNpVeaxd3UKGMdDP-GVQ.png"/><figcaption>SAM: The AWS Serverless Application Model</figcaption></figure></div><p id="ee44">é¦–å…ˆï¼Œéµå¾ªSAM CLI çš„<a href="https://github.com/awslabs/aws-sam-cli/blob/develop/docs/installation.rst" target="_blank" rel="noreferrer noopener">å®‰è£…è¯´æ˜ã€‚<br/> <br/>ç„¶åï¼Œåœ¨æˆ‘ä»¬çš„<code>photo-albums</code>é¡¹ç›®ç›®å½•ä¸­ï¼Œä½¿ç”¨SAM CLIå¼•å¯¼ä¸€ä¸ªæ–°çš„Node.js 8.10å‡½æ•°ã€‚</a></p><p id="e9f2">è¿è¡Œ<code>sam init --runtime nodejs8.10 --name photo_processor</code> <br/> <br/>è¿™å°†åœ¨<code>photo_processor/hello_world</code>ä¸­åˆ›å»ºä¸€ä¸ªç¤ºä¾‹å‡½æ•°ã€‚è®©æˆ‘ä»¬æŠŠ<code>photo_processor/hello_world</code>æ”¹åä¸ºæ›´åˆé€‚çš„åå­—:<code>photo_processor/src</code>ã€‚æ­¤å¤–ï¼Œè™½ç„¶æˆ‘æ˜¯å•å…ƒæµ‹è¯•çš„ç²‰ä¸ï¼Œä½†æˆ‘ä»¬ä¸æ‰“ç®—åœ¨æœ¬æ•™ç¨‹ä¸­ç¼–å†™ä»»ä½•å•å…ƒæµ‹è¯•ï¼Œæ‰€ä»¥åˆ é™¤<code>photo_processor/src/tests</code>ç›®å½•ï¼Œå› ä¸ºä¸€æ—¦æˆ‘ä»¬ç¼–å†™äº†ç…§ç‰‡å¤„ç†ä»£ç ï¼Œé‚£é‡Œçš„å ä½ç¬¦æµ‹è¯•å°±æ— å…³ç´§è¦äº†ã€‚ç°åœ¨æ˜¯æ—¶å€™å¼€å§‹å†™ä¸€äº›ä»£ç æ¥å“åº”æ¥è‡ªS3æ¡¶çš„äº‹ä»¶å’Œè°ƒæ•´æˆ‘ä»¬çš„ä¸Šä¼ äº†ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œåœ¨Node.jsä¸­æ‰§è¡Œç…§ç‰‡å¤§å°è°ƒæ•´çš„ä¸€ä¸ªæµè¡Œé€‰æ‹©æ˜¯<a href="http://sharp.dimens.io/en/stable/" target="_blank" rel="noreferrer noopener"> Sharp </a>ï¼Œå› æ­¤ä¸‹é¢æ˜¯æˆ‘ä»¬çš„AWS Lambdaå‡½æ•°ï¼Œæˆ‘ä»¬åº”è¯¥å°†å®ƒæ”¾åœ¨<code>photo_processor/src/app.js</code>ä¸­ã€‚</p><p id="e9f2">å½“æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨S3 APIæ—¶ï¼Œæˆ‘ä»¬è¿˜å°†åŒ…å«å¤„ç†ä»ä¸Šä¼ æ–‡ä»¶ä¸­è·å–å…ƒæ•°æ®æ‰€éœ€çš„ä»£ç ï¼Œå› ä¸ºåœ¨æœ¬æ–‡åé¢å°†ç…§ç‰‡ä¿¡æ¯å­˜å‚¨åˆ°DynamoDBæ—¶ï¼Œæˆ‘ä»¬å°†éœ€è¦è¿™äº›ä¿¡æ¯ã€‚</p><p id="07cd">å°†æ­¤å†…å®¹ç²˜è´´åˆ°<code>photo_processor/src/app.js</code>:</p><pre class="wp-block-code"><code>// photo_processor/src/app.js
const AWS = require('aws-sdk');
const S3 = new AWS.S3({ signatureVersion: 'v4' });
// Note: Sharp requires native extensions. To get sharp to install from NPM in a
// way that's compatible with the Amazon Linux environment that AWS runs Node.js
// on, we can use this command: docker run -v "$PWD":/var/task lambci/lambda:build-nodejs8.10 npm install
const Sharp = require('sharp');
// We'll expect these environment variables to be defined when the Lambda function is deployed
const THUMBNAIL_WIDTH = parseInt(process.env.THUMBNAIL_WIDTH, 10);
const THUMBNAIL_HEIGHT = parseInt(process.env.THUMBNAIL_HEIGHT, 10);
function thumbnailKey(filename) {
    return `public/resized/${filename}`;
}
function fullsizeKey(filename) {
    return `public/${filename}`;
}
function makeThumbnail(photo) {
    return Sharp(photo).resize(THUMBNAIL_WIDTH, THUMBNAIL_HEIGHT).toBuffer();
}
async function resize(bucketName, key) {
    const originalPhoto = (await S3.getObject({ Bucket: bucketName, Key: key }).promise()).Body;
    const originalPhotoName = key.replace('uploads/', '');
    const originalPhotoDimensions = await Sharp(originalPhoto).metadata();
    const thumbnail = await makeThumbnail(originalPhoto);
    await Promise.all([
        S3.putObject({
            Body: thumbnail,
            Bucket: bucketName,
            Key: thumbnailKey(originalPhotoName),
        }).promise(),
        S3.copyObject({
            Bucket: bucketName,
            CopySource: bucketName + '/' + key,
            Key: fullsizeKey(originalPhotoName),
        }).promise(),
    ]);
    await S3.deleteObject({
        Bucket: bucketName,
        Key: key
    }).promise();
    return {
        photoId: originalPhotoName,
        
        thumbnail: {
            key: thumbnailKey(originalPhotoName),
            width: THUMBNAIL_WIDTH,
            height: THUMBNAIL_HEIGHT
        },
        fullsize: {
            key: fullsizeKey(originalPhotoName),
            width: originalPhotoDimensions.width,
            height: originalPhotoDimensions.height
        }
    };
};
async function processRecord(record) {
    const bucketName = record.s3.bucket.name;
    const key = record.s3.object.key;
    if (key.indexOf('uploads') != 0) return;
    return await resize(bucketName, key);
}
exports.lambda_handler = async (event, context, callback) =&gt; {
    try {
        event.Records.forEach(processRecord);
        callback(null, { status: 'Photo Processed' });
    }
    catch (err) {
        console.error(err);
        callback(err);
    }
};</code></pre><p>æ¥ä¸‹æ¥ï¼Œç”¨ä¸‹é¢çš„æ–‡ä»¶æ›¿æ¢è‡ªåŠ¨ç”Ÿæˆçš„package.jsonæ–‡ä»¶ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è·Ÿè¸ªæˆ‘ä»¬å¯¹Sharpçš„ä¾èµ–ã€‚å°†ä»¥ä¸‹å†…å®¹ç²˜è´´åˆ°<code>photo_processor/src/package.json</code>:</p><pre class="wp-block-code"><code>{
  "name": "photo_processor",
  "version": "1.0.0",
  "description": "Our Photo Album uploads processor",
  "main": "src/app.js",
  "dependencies": {
    "sharp": "^0.20.2"
  }
}</code></pre><p id="3cd9">æœ€åï¼Œå®‰è£…æˆ‘ä»¬å‡½æ•°çš„ä¾èµ–é¡¹ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Sharpï¼Œå®ƒéœ€è¦æœ¬åœ°æ‰©å±•ä½œä¸ºå…¶å®‰è£…çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è®©NPMåœ¨äºšé©¬é€ŠLinuxç¯å¢ƒä¸­å®‰è£…Sharpï¼Œå› ä¸ºAWS Lambdaå°†åœ¨è¯¥æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œæˆ‘ä»¬çš„åŠŸèƒ½ã€‚å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªdockerå›¾åƒå¯ä»¥ä½¿è¿™å˜å¾—å®¹æ˜“ã€‚<br/> <br/>ä»photo_processor/srcç›®å½•ä¸­ï¼Œè¿è¡Œ<code>docker run -v "$PWD":/var/task lambci/lambda:build-nodejs8.10 npm install</code> <br/> <br/>ï¼Œå®ƒä¼šå¤„ç†æˆ‘ä»¬éœ€è¦çš„ä¸€åˆ‡ï¼Œä»¥ä¾¿å°†æˆ‘ä»¬çš„åŠŸèƒ½æ‰“åŒ…å¹¶éƒ¨ç½²åˆ°äº‘ä¸­çš„AWS Lambdaã€‚</p><h3 id="6bfe">æ‰“åŒ…å’Œéƒ¨ç½²Lambdaå‡½æ•°</h3><p id="1c75">SAM CLIæœ‰åŠ©äºå¼•å¯¼Lambdaå‡½æ•°(æˆ‘ä»¬åœ¨ä¸Šé¢å·²ç»åšè¿‡äº†)ï¼Œå®ƒè¿˜å¯ä»¥è´Ÿè´£æ‰“åŒ…å’Œéƒ¨ç½²Lambdaå‡½æ•°ã€‚å½“æˆ‘ä»¬å¼•å¯¼æˆ‘ä»¬çš„å‡½æ•°æ—¶ï¼ŒSAM CLIè¿˜ç”Ÿæˆäº†ä¸€ä¸ªSAMæ¨¡æ¿æ–‡ä»¶(YAMLæ ¼å¼)ï¼Œå®ƒå°†è¢«é¢„å¤„ç†æˆAWS CloudFormationæ¨¡æ¿æ–‡ä»¶ã€‚ç”Ÿæˆçš„template.ymlå®šä¹‰äº†ä¸€ä¸ªLambdaå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨å“åº”HTTPè¯·æ±‚æ—¶è¢«è§¦å‘ã€‚</p><h4 id="53d7">åˆ›å»ºSAMæ¨¡æ¿æ–‡ä»¶</h4><p id="47c2">åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦å®šä¹‰ä¸€ä¸ªLambdaå‡½æ•°ï¼Œå®ƒæœ‰æƒé™åœ¨æˆ‘ä»¬çš„å­˜å‚¨æ¡¶ä¸Šå·¥ä½œå¹¶å‘Amazon CloudWatchå†™å…¥æ—¥å¿—ã€‚æˆ‘ä»¬ä¸éœ€è¦è®¾ç½®HTTPç«¯ç‚¹è§¦å‘å™¨ï¼Œä½†æ˜¯æˆ‘ä»¬å¸Œæœ›åŒ…å«è°ƒæ•´å¤§å°å‡½æ•°æ‰€æœŸæœ›çš„ç¼©ç•¥å›¾å®½åº¦å’Œé«˜åº¦ç¯å¢ƒå˜é‡ã€‚æ­¤å¤–ï¼Œç”±äºæˆ‘ä»¬çš„å­˜å‚¨æ¡¶æ˜¯ä½¿ç”¨ä¸åŒçš„äº‘å½¢æˆæ¨¡æ¿(é€šè¿‡Amplify CLI)åˆ›å»ºçš„ï¼Œæˆ‘ä»¬å°†é…ç½®è¯¥æ¨¡æ¿ï¼Œä»¥æœŸæœ›æˆ‘ä»¬å°†å­˜å‚¨æ¡¶çš„Amazonèµ„æºåç§°ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è®¾ç½®é€‚å½“çš„æƒé™ã€‚ä¸‹é¢çš„<br/> <br/>æ˜¯ä¸€ä¸ªè´Ÿè´£è¿™ä¸€åˆ‡çš„SAM <code>template.yml</code>æ–‡ä»¶ã€‚ç”¨ä»¥ä¸‹å†…å®¹æ›¿æ¢<code>photo_processor/template.yml</code>çš„å†…å®¹:</p><pre class="wp-block-code"><code># photo_processor/template.yml
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: &gt;
    photo_processor
    Sample SAM Template for photo_processor
Parameters:
    S3UserfilesBucketArn:
        Type: String
    
Globals:
    Function:
        Timeout: 10
Resources:
    PhotoProcessorFunctionIamRole: 
        Type: "AWS::IAM::Role"
        Properties:
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - 
                        Effect: Allow
                        Principal:
                            Service: [lambda.amazonaws.com]
                        Action: ["sts:AssumeRole"]
            ManagedPolicyArns: ["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]
            Path: "/"
            Policies: 
                - 
                    PolicyName: "AllPrivsForPhotoAlbumUserfilesBucket"
                    PolicyDocument: 
                        Version: "2012-10-17"
                        Statement: 
                            -
                                Effect: "Allow"
                                Action: "s3:*"
                                Resource: !Join ["/", [!Ref S3UserfilesBucketArn, "*"]]
    PhotoProcessorFunction:
        Type: AWS::Serverless::Function
        Properties:
            CodeUri: src/
            Handler: app.lambda_handler
            Role: !GetAtt PhotoProcessorFunctionIamRole.Arn
            Runtime: nodejs8.10
            Environment:
                Variables:
                    THUMBNAIL_WIDTH: 80
                    THUMBNAIL_HEIGHT: 80
    BucketPermission:
        Type: AWS::Lambda::Permission
        Properties:
            Action: 'lambda:InvokeFunction'
            FunctionName: !Ref PhotoProcessorFunction
            Principal: s3.amazonaws.com
            SourceAccount: !Ref "AWS::AccountId"
            SourceArn: !Ref S3UserfilesBucketArn
Outputs:
    PhotoProcessorFunction:
      Description: "Photo Processor Lambda Function ARN"
      Value: !GetAtt PhotoProcessorFunction.Arn
    PhotoProcessorFunctionIamRole:
      Description: "IAM Role created for Photo Processor function"
      Value: !GetAtt PhotoProcessorFunctionIamRole.Arn</code></pre><h4 id="2bea">æ‰“åŒ…SAMæ¨¡æ¿æ–‡ä»¶</h4><p id="734d">å‡†å¤‡å¥½SAMæ¨¡æ¿åï¼Œæ‚¨éœ€è¦è®©SAMæ‰“åŒ…æ‚¨çš„Lambdaå‡½æ•°ï¼Œä½¿å…¶å‹ç¼©å‡½æ•°åŠå…¶ä¾èµ–é¡¹ï¼Œç”Ÿæˆæœ€ç»ˆçš„CloudFormationæ¨¡æ¿ï¼Œå¹¶å°†CloudFormationæ¨¡æ¿ä¸Šä¼ åˆ°S3å­˜å‚¨æ¡¶(æ‰€æœ‰CloudFormationæ¨¡æ¿å¿…é¡»å­˜åœ¨äºS3å­˜å‚¨æ¡¶ä¸­æ‰èƒ½æ‰§è¡Œ)ã€‚<br/> <br/>ä½œä¸ºä¸€æ¬¡æ€§æ“ä½œï¼Œåˆ›å»ºä¸€ä¸ªS3å­˜å‚¨æ¡¶æ¥æ‰˜ç®¡è¿™ä¸ª(ä»¥åŠä»»ä½•æœªæ¥çš„äº‘ä¿¡æ¯)æ¨¡æ¿ï¼Œæ³¨æ„åˆ›å»ºå…·æœ‰å”¯ä¸€åç§°çš„å­˜å‚¨æ¡¶ï¼Œå¹¶æŒ‡å®šReactåº”ç”¨ç¨‹åºçš„<code>src/aws-exports.js</code>æ–‡ä»¶ä¸­å¼•ç”¨çš„ç›¸åŒåŒºåŸŸã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤(ä½¿ç”¨é€‚å½“çš„æ›¿æ¢):</p><pre class="wp-block-code"><code>export MY_UNIQUE_CLOUDFORMATION_TEMPLATES_BUCKET_NAME=PickAUniqueNameHere
aws s3 mb s3://$MY_UNIQUE_CLOUDFORMATION_TEMPLATES_BUCKET_NAME --region us-east-1</code></pre><h4 id="bf38">éƒ¨ç½²SAMæ¨¡æ¿æ–‡ä»¶</h4><p id="1aa1">ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨SAM CLIå°†æˆ‘ä»¬çš„Lambdaå‡½æ•°æ‰“åŒ…å¹¶éƒ¨ç½²åˆ°äº‘ä¸­ã€‚ä»<code>photo_processor</code>ç›®å½•ä¸­ï¼Œè¿è¡Œ:</p><pre class="wp-block-code"><code>sam package \
--template-file template.yaml \
--output-template-file packaged.yml \
--s3-bucket $MY_UNIQUE_CLOUDFORMATION_TEMPLATES_BUCKET_NAME</code></pre><p id="a40d">æœ€åï¼Œæ˜¯æ—¶å€™éƒ¨ç½²Lambdaå‡½æ•°äº†ã€‚å‰é¢çš„å‘½ä»¤åœ¨<code>template.yml</code>æ–‡ä»¶æ—è¾¹åˆ›å»ºäº†ä¸€ä¸ª<code>packaged.yml</code>å‡½æ•°ï¼Œå¹¶ä¸Šä¼ äº†ä¸€ä¸ªlambdaå‡½æ•°åŠå…¶ä¾èµ–é¡¹çš„zipæ–‡ä»¶ã€‚æˆ‘ä»¬å°†åœ¨éƒ¨ç½²å‘½ä»¤ä¸­å¼•ç”¨å®ƒï¼Œä½†æˆ‘ä»¬è¿˜éœ€è¦ä¼ å…¥ä¸€ä¸ªå‚æ•°æ¥å‘Šè¯‰CloudFormationæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç”¨äºæ–‡ä»¶å­˜å‚¨çš„S3å­˜å‚¨æ¡¶çš„ARNã€‚åœ¨Reactåº”ç”¨ç¨‹åºçš„<code>src/aws-exports.js</code>æ–‡ä»¶ä¸­æŸ¥æ‰¾<code>aws_user_files_s3_bucket</code>å€¼ï¼Œå¹¶åœ¨ä¸‹é¢æ›¿æ¢å®ƒã€‚</p><p id="109e">åœ¨<code>photo_processor</code>ç›®å½•ä¸­ï¼Œè¿è¡Œ(é€‚å½“æ›¿æ¢<code>S3UserfilesBucketArn</code>):</p><pre class="wp-block-code"><code>export MY_AWS_USERFILES_S3_BUCKET_ARN=arn:aws:s3:::my-aws-user-files-s3-bucket-name
sam deploy \
--template-file packaged.yml \
--stack-name PhotoAlbumsProcessorSAMStack \
--capabilities CAPABILITY_IAM \
--parameter-overrides \
--region us-east-1 \
S3UserfilesBucketArn=$MY_AWS_USERFILES_S3_BUCKET_ARN</code></pre><p id="b1b0">ç»è¿‡çŸ­æš‚çš„ç­‰å¾…ï¼Œæˆ‘ä»¬çš„Lambdaå‡½æ•°åº”è¯¥å·²ç»éƒ¨ç½²å¥½äº†ï¼Œå¯ä»¥è¿æ¥åˆ°S3æ¥è°ƒæ•´ç…§ç‰‡çš„å¤§å°äº†ï¼å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥åœ¨<a href="https://github.com/awslabs/aws-sam-cli/blob/develop/docs/deploying_serverless_applications.rst" target="_blank" rel="noreferrer noopener">éƒ¨ç½²æ— æœåŠ¡å™¨åº”ç”¨æ–‡æ¡£</a>ä¸­é˜…è¯»æ›´å¤šå…³äºç”¨AWS SAMæ‰“åŒ…å’Œéƒ¨ç½²Lambdaå‡½æ•°çš„ä¿¡æ¯ã€‚</p><h3 id="7149">å½“ç…§ç‰‡ä¸Šä¼ åˆ°S3æ—¶è°ƒç”¨æˆ‘ä»¬çš„Lambdaå‡½æ•°</h3><p id="73df">ç°åœ¨æˆ‘ä»¬çš„ç…§ç‰‡å¤§å°è°ƒæ•´Lambdaå‡½æ•°å·²ç»éƒ¨ç½²å¥½äº†ï¼Œæˆ‘ä»¬éœ€è¦å‘å®ƒæ·»åŠ ä¸€ä¸ª<em>äº‹ä»¶æº</em>,è¿™æ ·æ¯å½“æœ‰æ–°ç…§ç‰‡ä¸Šä¼ åˆ°æˆ‘ä»¬çš„å­˜å‚¨æ¡¶æ—¶ï¼Œå®ƒå°±ä¼šè¢«è°ƒç”¨ã€‚</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/5294f388bb70fdb06364d189dc2bf546.png" alt="" class="wp-image-42767" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_VoPMoIwNTaxqPNO07v8vjg.png"/><figcaption>Adding S3 uploads as a trigger for our photo_processor LambdaÂ function</figcaption></figure></div><p id="3b31">ä»¥ä¸‹æ˜¯å¦‚ä½•è¿æ¥S3æ¡¶ä¸Šä¼ è§¦å‘æˆ‘ä»¬çš„Lambda:</p><ol><li>æ‰“å¼€AWS webæ§åˆ¶å°ï¼Œç¡®ä¿æ‚¨ä½äºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ­£åœ¨ä½¿ç”¨çš„åŒä¸€åŒºåŸŸï¼Œå¹¶åŠ è½½Lambdaæ§åˆ¶å°é¡µé¢</li><li>æ‰¾åˆ°æˆ‘ä»¬çš„Lambdaå‡½æ•°çš„åç§°ï¼Œå…¶ä¸­åº”è¯¥æœ‰â€œPhotoProcessorFunctionâ€(å¦‚æœæ‚¨æœ‰å¾ˆå¤šå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨æœç´¢æ¡†ç¼©å°å‡½æ•°åˆ—è¡¨)ï¼Œç„¶åå•å‡»è¯¥å‡½æ•°ä»¥æŸ¥çœ‹å’Œç®¡ç†å…¶é…ç½®</li><li>åœ¨é¡µé¢é¡¶éƒ¨çš„è®¾è®¡å™¨éƒ¨åˆ†ï¼Œä»å·¦ä¾§çš„â€œæ·»åŠ è§¦å‘å™¨â€åˆ—è¡¨ä¸­å•å‡»S3</li><li>åœ¨å‡ºç°çš„â€œé…ç½®è§¦å‘å™¨â€éƒ¨åˆ†:<br/> a .é€‰æ‹©æ‚¨çš„å­˜å‚¨æ¡¶çš„åç§°(æ‚¨å¯ä»¥åœ¨<code>src/aws-exports.js</code>æ–‡ä»¶ä¸­æŸ¥æ‰¾)<br/> b .é€‰æ‹©ä¸Šä¼ äº‹ä»¶ç±»å‹<br/> c .è¾“å…¥â€œä¸Šä¼ /â€ä½œä¸ºå‰ç¼€<br/> d .å•å‡»â€œæ·»åŠ â€</li><li>ç‚¹å‡»å³ä¸Šè§’çš„æ©™è‰²â€œä¿å­˜â€æŒ‰é’®</li></ol><p id="ec09">å®Œæˆåï¼Œæ¯å½“æ–°ç…§ç‰‡å‡ºç°åœ¨å‰ç¼€ä¸º<code>uploads/</code>çš„S3æ¡¶ä¸­æ—¶ï¼Œå°±åº”è¯¥è°ƒç”¨ç…§ç‰‡å¤§å°è°ƒæ•´Lambdaå‡½æ•°ã€‚æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ç›¸å†Œè¯¦ç»†ä¿¡æ¯webç•Œé¢å°†æ–°ç…§ç‰‡ä¸Šä¼ åˆ°ç›¸å†Œæ¥æ£€æŸ¥äº‹æƒ…æ˜¯å¦æ­£å¸¸ï¼Œç„¶åä½¿ç”¨S3 webæ§åˆ¶å°æµè§ˆå­˜å‚¨æ¡¶çš„å†…å®¹ï¼›åœ¨<code>public/</code>å’Œ<code>public/resized/</code>æ‰¾ä¸€å¼ åŒåçš„ç…§ç‰‡ã€‚</p><h3 id="e3b3">å°†ç…§ç‰‡å…ƒæ•°æ®å­˜å‚¨åœ¨DynamoDBä¸­</h3><p id="b00e">åœ¨æ˜¾ç¤ºç›¸å†Œä¸­çš„æ‰€æœ‰ç…§ç‰‡ä¹‹å‰ï¼Œæˆ‘ä»¬çš„æœ€åä¸€æ­¥æ˜¯å‘DynamoDBä¸­çš„ä¸€ä¸ªè¡¨æ·»åŠ ä¸€ä¸ªæ–°æ¡ç›®ï¼Œå…¶ä¸­åŒ…å«å…³äºç…§ç‰‡çš„å…ƒæ•°æ®ã€‚æˆ‘ä»¬åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­å®šä¹‰çš„GraphQLæ¨¡å¼æè¿°äº†ä¸€ä¸ªè¿æ¥åˆ°<code>Album</code>çš„<code>Photo</code>ç±»å‹ã€‚å¦‚æœæˆ‘ä»¬å°†æ–°é¡¹ç›®æ”¾å…¥æˆ‘ä»¬çš„<a href="https://acloudguru.com/course/introduction-to-aws-appsync"> AppSync </a> Photoçš„datasourceä¸­æè¿°çš„è¡¨ä¸­ï¼Œå½“æˆ‘ä»¬è¯•å›¾é€šè¿‡GraphQLæŸ¥è¯¢è·å–ç›¸å†Œçš„åµŒå¥—ç…§ç‰‡æ—¶ï¼Œè¯¥ä¿¡æ¯å°†æ˜¯å¯ç”¨çš„ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†æ·»åŠ ç°æœ‰çš„<code>photo_processor</code> Lambdaå‡½æ•°ï¼Œè€Œä¸æ˜¯åˆ›å»ºå¦ä¸€ä¸ªå‡½æ•°ã€‚æˆ‘ä»¬éœ€è¦ä¸ºæ’å…¥åˆ°Dynamoä¸­çš„æ¯å¼ ç…§ç‰‡ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„IDï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å¼•å…¥å¦ä¸€ä¸ªåŒ…ã€‚ä»<code>photo_processor/src</code>ç›®å½•ï¼Œè¿è¡Œ:<code>npm install --save uuid</code> <br/> <br/>ç”±äºDynamoDBæ–‡æ¡£å®¢æˆ·ç«¯ç±»çš„å­˜åœ¨ï¼Œä»JavaScriptå’ŒAWS JS SDKä½¿ç”¨DynamoDBå˜å¾—éå¸¸å®¹æ˜“ã€‚å¯¹<code>photo_processor/app.js</code>è¿›è¡Œå¦‚ä¸‹æ›´æ”¹:</p><pre class="wp-block-code"><code>// photo_processor/app.js
// 1. NEW: Import the DynamoDB DocumentClient and the uuid module
const DynamoDBDocClient = new AWS.DynamoDB.DocumentClient({apiVersion: '2012-08-10'});
const uuidv4 = require('uuid/v4');

// 2. NEW: Extract the name of the photos table 
//    from an environment variable (we'll set this value via
//    our SAM template below...)
const DYNAMODB_PHOTOS_TABLE_NAME = process.env.DYNAMODB_PHOTOS_TABLE_ARN.split('/')[1];

// 3. NEW: Add a new function to handle putting 
//    our new Photo info into DynamoDB
function storePhotoInfo(item) {
  const params = {
    Item: item,
    TableName: DYNAMODB_PHOTOS_TABLE_NAME
  };
  return DynamoDBDocClient.put(params).promise();
}

// 4. NEW: Add a new function to get the metadata for a photo
async function getMetadata(bucketName, key) {
  const headResult = await S3.headObject({Bucket: bucketName, Key: key }).promise();
  return headResult.Metadata;
}

// 5. EDIT: Replace processRecord() with this definition, 
//    which passes the metadata and the sizes info 
//    to storePhotoInfo(). 
//
//    We'll also add a createdAt property to our photo items 
//    which will be helpful when we get around to 
//    paginating photos in date order.
async function processRecord(record) {
  const bucketName = record.s3.bucket.name;
  const key = record.s3.object.key;
    
  if (key.indexOf('uploads') != 0) return;
    
  const metadata = await getMetadata(bucketName, key);
  const sizes = await resize(bucketName, key);    
  const id = uuidv4();
  const item = {
    id: id,
    owner: metadata.owner,
    photoAlbumId: metadata.albumid,
    bucket: bucketName,
    thumbnail: sizes.thumbnail,
    fullsize: sizes.fullsize,
    createdAt: new Date().getTime()
  }
  await storePhotoInfo(item);
}</code></pre><p>æ›´æ–°SAM <code>template.yml</code>æ–‡ä»¶ï¼Œæ·»åŠ æˆ‘ä»¬åœ¨ä¸Šé¢ä»‹ç»çš„æ–°ç¯å¢ƒå˜é‡ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæ–°çš„ç­–ç•¥ï¼Œå…è®¸æˆ‘ä»¬çš„Lambdaå‡½æ•°å†™å…¥ç…§ç‰‡è¡¨:</p><pre class="wp-block-code"><code># photo_processor/template.yml
# ...
Parameters:
    # ...
    
    # 1. NEW: Add another parameter
    DynamoDBPhotosTableArn:
        Type: String
# ...
Resources:
    # ....
    PhotoProcessorFunctionIamRole:
        Properties:
            # ...
            Policies:
                # ...
                
                # 2. NEW: Add another policy
                - 
                    PolicyName: "AllPrivsForDynamo"
                    PolicyDocument: 
                        Version: "2012-10-17"
                        Statement: 
                            -
                                Effect: "Allow"
                                Action: "dynamodb:*"
                                Resource: 
                                    - !Ref DynamoDBPhotosTableArn
    
# ...
    
    PhotoProcessorFunction:
        # ...
            Environment:
                Variables:
                    # ...
                    
                    # 3. NEW: add a new environment 
                    #    variable referencing our param
                    DYNAMODB_PHOTOS_TABLE_ARN: !Ref DynamoDBPhotosTableArn</code></pre><p id="eb49">å®Œæˆè¿™äº›æ›´æ”¹åï¼Œæˆ‘ä»¬çš„<code>photo_processor</code> Lambdaç°åœ¨åº”è¯¥ä¸ºæ¯å¼ ä¸Šä¼ çš„ç…§ç‰‡åˆ›å»ºä¸€ä¸ªç¼©ç•¥å›¾ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„photos DynamoDBè¡¨ä¸­åˆ›å»ºä¸€ä¸ªæ–°è®°å½•ï¼Œè¯¥è®°å½•åŒ…å«è®©æˆ‘ä»¬çš„å‰ç«¯å¾ˆå¥½åœ°å‘ˆç°ç›¸å†Œæ‰€éœ€çš„æ•°æ®ã€‚</p><p id="a460">ç°åœ¨æ˜¯æ—¶å€™éƒ¨ç½²Lambdaå‡½æ•°çš„æ›´æ–°ç‰ˆæœ¬äº†(é‡å¤æˆ‘ä»¬ä¹‹å‰è¿è¡Œçš„ç›¸åŒçš„samåŒ…å’Œsam deployå‘½ä»¤)ã€‚å‡è®¾ä¹‹å‰å¯¼å‡ºçš„å˜é‡ä»ç„¶å­˜åœ¨(æ‚¨åœ¨åŒä¸€ä¸ªç»ˆç«¯ä¼šè¯ä¸­)ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºDynamoDBç…§ç‰‡è¡¨ARNå®šä¹‰ä¸€ä¸ªæ–°çš„ç¯å¢ƒå˜é‡ã€‚</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/135d08da9048cbe18c3bba5292ebf42b.png" alt="" class="wp-image-42768" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_f6RfUjvnZtKKhSBjJ32rCg.png"/><figcaption>Viewing the data sources for our AppSyncÂ AP</figcaption></figure></div><p id="ea6a">è¦æŸ¥æ‰¾æ­£ç¡®çš„ç…§ç‰‡è¡¨ï¼ŒARN:</p><ol><li>è½¬åˆ°AWS AppSync webæ§åˆ¶å°ä¸­çš„API</li><li>å•å‡»â€œæ•°æ®æºâ€</li><li>æ‰¾åˆ°PhotoTableæ¡ç›®ï¼Œå•å‡»è¡¨åçš„é“¾æ¥ï¼Œè½¬åˆ°DynamoDB webæ§åˆ¶å°</li><li>å¤åˆ¶DynamoDBè¡¨æ ¼æ¦‚è¿°é€‰é¡¹å¡åº•éƒ¨çš„ARN</li></ol><p id="761f">æ‰¾åˆ°ARNåï¼Œå°†å…¶æ›¿æ¢åˆ°ä¸‹é¢çš„exportè¯­å¥ä¸­ï¼Œå¹¶åœ¨SAMå‘½ä»¤ä½¿ç”¨çš„åŒä¸€ç»ˆç«¯çª—å£ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤(å› æ­¤æˆ‘ä»¬å·²ç»è®¾ç½®çš„å…¶ä»–ç¯å¢ƒå˜é‡ä»ç„¶æ˜¯å®šä¹‰çš„)ã€‚æ³¨æ„:ä¸è¦æ”¹å˜ä¸‹é¢çš„<code>stack-name</code>å‚æ•°ï¼›æˆ‘ä»¬å¸Œæœ›å®ƒä¸Amplifyåˆ›å»ºçš„å †æ ˆæœ‰æ‰€ä¸åŒã€‚</p><p id="4bd1">ä»<code>photo_processor</code>ç›®å½•ä¸­ï¼Œè¿è¡Œ:</p><pre class="wp-block-code"><code># Fill in the value below with the ARN for your DynamoDB Photos table
export MY_DYNAMODB_PHOTOS_TABLE_ARN=my-dynamo-db-photos-table-arn
sam package \
--template-file template.yaml \
--output-template-file packaged.yml \
--s3-bucket $MY_UNIQUE_CLOUDFORMATION_TEMPLATES_BUCKET_NAME
sam deploy \
--template-file packaged.yml \
--stack-name PhotoAlbumsProcessorSAMStack \
--capabilities CAPABILITY_IAM \
--region us-east-1 \
--parameter-overrides \
S3UserfilesBucketArn=$MY_AWS_USERFILES_S3_BUCKET_ARN \
DynamoDBPhotosTableArn=$MY_DYNAMODB_PHOTOS_TABLE_ARN</code></pre><p id="e41a">ä»ç°åœ¨å¼€å§‹ï¼Œæˆ‘ä»¬ä»åº”ç”¨ç¨‹åºä¸Šä¼ çš„ä»»ä½•æ–°ç…§ç‰‡éƒ½åº”è¯¥åœ¨photos DynamoDBè¡¨ä¸­æœ‰ä¸€è¡Œã€‚å°è¯•ä»å‰ç«¯è¿›è¡Œå¦ä¸€æ¬¡ä¸Šä¼ ï¼Œåœ¨ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹æ˜¯å¦å¯ä»¥é€šè¿‡GraphQLè·å–ç…§ç‰‡ä¿¡æ¯ã€‚</p><h3 id="d135">ä¸ºç›¸å†Œè·å–ç…§ç‰‡</h3><p id="79ea">æˆ‘ä»¬çš„GraphQLæ¨¡å¼å·²ç»è¡¨æ˜ä¸€ä¸ª<code>Album</code>ä¸­æœ‰ä¸€ä¸ª<code>Photos</code>å­—æ®µ(ç±»å‹ä¸º<code>[Photo]</code>)ã€‚æˆ‘ä»¬å·²ç»æ³¨æ„åˆ°å‘ä¿å­˜ç…§ç‰‡ä¿¡æ¯çš„DynamoDBè¡¨å†™å…¥è¡Œï¼Œé€šè¿‡æ¯å¼ ç…§ç‰‡ä¸Šä¼ æœŸé—´æä¾›çš„<code>albumid</code>å…ƒæ•°æ®å°†æ¯ä¸ªæ¡ç›®é“¾æ¥åˆ°ä¸€ä¸ªç›¸å†Œã€‚Amplify CLIå·²ç»ç¼–å†™äº†ä¸€ä¸ªè§£æå™¨æ¥æ­£ç¡®æŸ¥æ‰¾ç»™å®šç›¸å†Œçš„ç›¸å…³ç…§ç‰‡ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿå‘GraphQLè¯·æ±‚å±äºæŸä¸ªç‰¹å®šç›¸å†Œçš„ç…§ç‰‡ã€‚è®©æˆ‘ä»¬è¯•ä¸€è¯•ã€‚</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/8b2e7c15ed337e1d5242e8d4182f5731.png" alt="" class="wp-image-42765" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_PG0Cbtc_Oesrq57OY4ITjQ.png"/><figcaption>Querying our AWS AppSync API in the webÂ console</figcaption></figure></div><p>å›åˆ°AWS AppSync webæ§åˆ¶å°ï¼Œè½¬åˆ°æŸ¥è¯¢éƒ¨åˆ†å¹¶è¿è¡Œä»¥ä¸‹æŸ¥è¯¢:</p><pre class="wp-block-code"><code>query AllAlbums {
  listAlbums {
    items {
      id
      name
      photos {
        items {
          id
          bucket
          thumbnail {
            width
            height
            key
          }
        }
      }
    }
  }
}</code></pre><p id="305d">å¦‚æœè‡ªä»æˆ‘ä»¬ä¸Šæ¬¡éƒ¨ç½²Lambdaä»¥æ¥ï¼Œä½ åœ¨ç›¸å†Œä¸­æ·»åŠ äº†ä»»ä½•ç…§ç‰‡ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€äº›ç›¸å†Œä¹ŸåŒ…å«äº†ç…§ç‰‡ï¼å‰©ä¸‹çš„å°±æ˜¯åœ¨æˆ‘ä»¬çš„UIä¸­æ˜¾ç¤ºè¿™äº›å›¾åƒã€‚</p><h3 id="25ef">æ¸²æŸ“ç›¸å†Œä¸­çš„æ‰€æœ‰ç…§ç‰‡</h3><p id="5cda">ä¸ºäº†æ¸²æŸ“æ¯å¼ ç…§ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨AWS Amplify JSåº“æä¾›çš„å¦ä¸€ä¸ªReactç»„ä»¶:<code>S3Image</code>(ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»å…³äºè¿™ä¸ªç»„ä»¶<a href="https://aws-amplify.github.io/amplify-js/media/storage_guide" target="_blank" rel="noreferrer noopener">çš„æ›´å¤šä¿¡æ¯)ã€‚è®©æˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„<code>GetAlbum</code>æŸ¥è¯¢æ¥è·å–ç›¸å†Œçš„ç…§ç‰‡ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„<code>PhotosList</code>ç»„ä»¶ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„<code>AlbumDetails</code>ç»„ä»¶ä¸­ä½¿ç”¨å®ƒã€‚å¯¹<code>src/App.js</code>è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹:</a></p><pre class="wp-block-code"><code>// src/App.js
// 1. NEW: Add an import of S3Image 
//    and add Divider to imports from semantic-ui-react
import { S3Image } from 'aws-amplify-react';
import { Divider, Form, Grid, Header, Input, List, Segment } from 'semantic-ui-react';

// 2. EDIT: Update our GetAlbum query to include 
//    fetching thumbnail info for each photo
const GetAlbum = `query GetAlbum($id: ID!) {
  getAlbum(id: $id) {
    id
    name
    photos {
      items {
        thumbnail {
          width
          height
          key
        }
      }
      nextToken
    }
  }
}
`;

// 3. NEW: Create a new PhotosList component
class PhotosList extends React.Component {
  photoItems() {
    return this.props.photos.map(photo =&gt;
      &lt;S3Image 
        key={photo.thumbnail.key} 
        imgKey={photo.thumbnail.key.replace('public/', '')} 
        style={{display: 'inline-block', 'paddingRight': '5px'}}
      /&gt;
    );
  }
  render() {
    return (
      &lt;div&gt;
        &lt;Divider hidden /&gt;
        {this.photoItems()}
      &lt;/div&gt;
    );
  }
}
// 4. EDIT: Add PhotosList to AlbumDetail's render()
class AlbumDetails extends Component {
  render() {
    return (
      &lt;Segment&gt;
        &lt;Header as='h3'&gt;{this.props.album.name}&lt;/Header&gt;
        &lt;S3ImageUpload albumId={this.props.album.id}/&gt;        
        &lt;PhotosList photos={this.props.album.photos.items} /&gt;
      &lt;/Segment&gt;
    )
  }
}</code></pre><p>å¦‚æœä½ ç°åœ¨åˆ·æ–°ä½ çš„åº”ç”¨ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸ºä½ æ­£åœ¨æŸ¥çœ‹çš„ç›¸å†ŒåŠ è½½çš„ç…§ç‰‡ã€‚å‘œï¼å¦‚æœä½ æ·»åŠ äº†æ–°çš„ç…§ç‰‡ï¼Œç­‰å¾…Lambdaå‡½æ•°è¢«S3è°ƒç”¨ï¼Œç„¶ååˆ·æ–°ï¼Œä½ çš„æ–°ç…§ç‰‡åº”è¯¥ä¹Ÿå¯ä»¥çœ‹åˆ°äº†ã€‚</p><div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" src="../Images/59499948c9264a5a779986950ea10f76.png" alt="" class="wp-image-42766" data-original-src="https://acg-wordpress-content-production.s3.us-west-2.amazonaws.com/app/uploads/2021/01/1_tWW36mTkr6M6PbwDZcSJTw.png"/><figcaption>Viewing an album after uploading someÂ photos</figcaption></figure></div><p id="ff5a">æ­¤æ—¶ï¼Œå…³äºæˆ‘ä»¬çš„ç…§ç‰‡åˆ—è¡¨ä½“éªŒï¼Œæœ‰ä¸‰ä»¶äº‹å€¼å¾—è®¨è®º:</p><ul><li>ä¸ºäº†çœ‹åˆ°æ–°ç…§ç‰‡è€Œåˆ·æ–°ç›¸å†Œè§†å›¾å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç”¨æˆ·ä½“éªŒï¼Œä½†æ˜¯è¿™ç¯‡æ–‡ç« å·²ç»ä»‹ç»äº†ç›¸å½“å¤šçš„å†…å®¹ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« è¿˜ä¼šä»‹ç»æ›´å¤šå†…å®¹ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå¤„ç†è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯è®©æˆ‘ä»¬çš„photo_processor Lambdaå‡½æ•°è§¦å‘APIä¸Šçš„ä¸€ä¸ªçªå˜ï¼Œå¹¶è®©AlbumDetailsLoaderç»„ä»¶è®¢é˜…è¿™ä¸ªçªå˜ã€‚ç„¶è€Œï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨Amazon Cognitoç”¨æˆ·æ± èº«ä»½éªŒè¯ï¼Œè®©æˆ‘ä»¬çš„Lambdaå‡½æ•°è§¦å‘è¿™ç§å˜å¼‚çš„å”¯ä¸€æ–¹æ³•æ˜¯åˆ›å»ºä¸€ç§â€œç³»ç»Ÿâ€ç”¨æˆ·(é€šè¿‡æ­£å¸¸çš„ç”¨æˆ·æ³¨å†Œå’Œç¡®è®¤è¿‡ç¨‹)ï¼Œå®‰å…¨åœ°å­˜å‚¨è¯¥ç”¨æˆ·çš„å‡­è¯(å¯èƒ½åœ¨<a href="https://aws.amazon.com/secrets-manager/" target="_blank" rel="noreferrer noopener"> AWS Secrets Manager </a>ä¸­)ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„Lambdaä¸­ä»¥è¯¥ç”¨æˆ·çš„èº«ä»½å‘æˆ‘ä»¬çš„AppSync APIè¿›è¡Œèº«ä»½éªŒè¯ï¼Œä»¥ä¾¿è§¦å‘å˜å¼‚ã€‚</li><li>å¦‚æœä¸€ä¸ªç›¸å†Œä¸­æœ‰å¾ˆå¤šç…§ç‰‡ï¼Œæˆ‘ä»¬çš„APIä¸ä¼šåœ¨ç¬¬ä¸€ä¸ª<code>getAlbum</code>æŸ¥è¯¢ä¸­è¿”å›æ‰€æœ‰ç…§ç‰‡ã€‚ç›¸åï¼Œæˆ‘ä»¬éœ€è¦å¢å¼ºæˆ‘ä»¬çš„<code>AlbumDetails</code>ç»„ä»¶ï¼Œä»¥å…è®¸ç”¨æˆ·å¯¹æ—§ç…§ç‰‡è¿›è¡Œåˆ†é¡µï¼ŒæŒ‰éœ€åŠ è½½æ›´å¤šå†…å®¹ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚</li><li>æˆ‘ä»¬ç›®å‰åªæ¸²æŸ“æ¯å¼ ç…§ç‰‡çš„ç¼©ç•¥å›¾ã€‚å½“ä½ ç‚¹å‡»ä¸€å¼ ç…§ç‰‡æ—¶ï¼Œæ˜¾ç¤ºå®ƒçš„å®Œæ•´å°ºå¯¸å¯èƒ½ä¼šå¾ˆå¥½ã€‚æˆ‘å°†æŠŠè¿™äº›æ”¹è¿›ç•™ç»™è¯»è€…ä½œä¸ºç»ƒä¹ ã€‚ğŸ™‚</li></ul><h3 id="2f7b">æ¥ä¸‹æ¥</h3><p id="b342">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»è®¨è®ºäº†å¾ˆå¤šå†…å®¹ã€‚æˆ‘ä»¬å‘Reactåº”ç”¨ç¨‹åºæ·»åŠ äº†è·¯ç”±ï¼Œåˆ›å»ºäº†ç”¨äºåŠ è½½å’Œå‘ˆç°ç›¸å†Œç»†èŠ‚ã€å°†ç…§ç‰‡ä¸Šä¼ åˆ°ç›¸å†Œä»¥åŠåœ¨ç›¸å†Œä¸­æ˜¾ç¤ºç…§ç‰‡çš„ç»„ä»¶ã€‚æˆ‘ä»¬åˆ¶ä½œäº†ä¸€ä¸ªAWS Lambdaå‡½æ•°æ¥ä¸ºæˆ‘ä»¬çš„ç…§ç‰‡è‡ªåŠ¨åˆ›å»ºç¼©ç•¥å›¾ï¼Œå¹¶ä¸”æˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨SAM CLIæ‰“åŒ…å’Œéƒ¨ç½²Lambdaã€‚<br/> <br/>åœ¨æœ¬ç³»åˆ—çš„<a href="https://read.acloud.guru/build-your-own-multi-user-photo-album-app-with-react-graphql-and-aws-amplify-bcaeba942159" target="_blank" rel="noreferrer noopener">ä¸‹ä¸€ç¯‡(ä¹Ÿæ˜¯æœ€åä¸€ç¯‡)</a>æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ”¹è¿›ç…§ç‰‡çš„åˆ—è¡¨å’Œåˆ†é¡µä½“éªŒï¼Œä¸ºæˆ‘ä»¬çš„ç›¸å†Œæ·»åŠ ç»†ç²’åº¦çš„å®‰å…¨æ€§ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†äº†è§£å¦‚ä½•å°†æˆ‘ä»¬çš„åº”ç”¨éƒ¨ç½²åˆ°CDNï¼Œä»¥åœ¨å…¨çƒèŒƒå›´å†…åŠ å¿«åŠ è½½é€Ÿåº¦ã€‚</p><p id="9561">å¦‚æœä½ æƒ³åœ¨æ–°å¸–å­å‘å¸ƒæ—¶å¾—åˆ°é€šçŸ¥ï¼Œè¯·åœ¨Twitterä¸Šå…³æ³¨æˆ‘:<a href="https://medium.com/@gabehollombe" target="_blank" rel="noreferrer noopener"> Gabe Hollombe </a>ã€‚å¦‚æœä½ å¯¹è¿™ç¯‡æ–‡ç« æœ‰ä»»ä½•é—®é¢˜æˆ–åé¦ˆï¼Œè¿™ä¹Ÿæ˜¯è”ç³»æˆ‘çš„æœ€å¥½æ–¹å¼ã€‚</p><p id="5c0e"><a href="https://acloudguru.com/blog/engineering/build-your-own-multi-user-photo-album-app-with-react-graphql-and-aws-amplify-part1" target="_blank" rel="noreferrer noopener"> <strong> <em>ç¬¬ä¸€éƒ¨åˆ†</em> </strong> </a> <strong> <em> |ç¬¬äºŒéƒ¨åˆ†| </em> </strong> <a href="https://acloudguru.com/blog/engineering/build-your-own-multi-user-photo-album-app-with-react-graphql-and-aws-amplify-part3" target="_blank" rel="noreferrer noopener"> <strong> <em>ç¬¬ä¸‰éƒ¨åˆ†</em> </strong> </a> <em> <br/>è¿™æ˜¯ä¸€ä¸ªç”±ä¸‰éƒ¨åˆ†ç»„æˆçš„ç³»åˆ—æ–‡ç« çš„ç¬¬äºŒç¯‡ï¼Œå‘æ‚¨å±•ç¤ºå¦‚ä½•åœ¨AWSä¸Šæ„å»ºä¸€ä¸ªå¯æ‰©å±•çš„ã€é«˜åº¦å¯ç”¨çš„æ— æœåŠ¡å™¨webåº”ç”¨ç¨‹åºï¼Œå…è®¸ç”¨æˆ·å°†ç…§ç‰‡ä¸Šä¼ åˆ°ç›¸å†Œå¹¶ä¸ä»–äººç§ä¸‹å…±äº«è¿™äº›ç›¸å†Œã€‚</em></p><h3 id="3e7a">å¯åŠ¨æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢æ‰€å»ºç«‹çš„</h3><p id="69c7">å¦‚æœä½ æƒ³æ£€æŸ¥ä¸€ä¸ªå›è´­å¹¶å¯åŠ¨æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢æ„å»ºçš„åº”ç”¨ç¨‹åºï¼Œè¯·åœ¨GitHubä¸Šæ£€æŸ¥è¿™ä¸ªå›è´­å¹¶ä½¿ç”¨blog-post-part-oneæ ‡ç­¾ï¼Œé“¾æ¥å¦‚ä¸‹:<a href="https://github.com/gabehollombe-aws/react-graphql-amplify-blog-post/tree/blog-post-part-two" target="_blank" rel="noreferrer noopener">https://GitHub . com/gabehollombe-AWS/react-graph QL-amplify-blog-post/tree/blog-post-part-two</a>ã€‚æŒ‰ç…§è‡ªè¿°æ–‡ä»¶ä¸­çš„æ­¥éª¤é…ç½®å’Œå¯åŠ¨åº”ç”¨ç¨‹åºã€‚</p></div></div>    
</body>
</html>